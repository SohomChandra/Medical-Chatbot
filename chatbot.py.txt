import os
import sys
from models.model_handler import predict_intent
from utils.response_generator import generate_response
from flask import Flask, request, jsonify
from auth.auth import oauth, login_required

app = Flask(__name__)
app.secret_key = 'random_secret_key'
oauth.init_app(app)

@app.route('/chat', methods=['POST'])
@login_required
def chat():
    data = request.get_json()
    text = data.get('text', '')
    
    try:
        prediction = predict_intent(text)
        response = generate_response(prediction, text)
        return jsonify({"response": response})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/login')
def login():
    redirect_uri = url_for('auth', _external=True)
    return oauth.google.authorize_redirect(redirect_uri)

@app.route('/auth/callback')
def auth():
    token = oauth.google.authorize_access_token()
    user_info = oauth.google.parse_id_token(token)
    session['user'] = user_info
    return redirect('/')

if __name__ == '__main__':
    app.run(debug=True)
